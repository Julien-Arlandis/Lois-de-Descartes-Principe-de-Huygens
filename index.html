<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Huygens : Version Finale</title>
    <style>
        body { 
            background: #000; color: #eee; font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 10px; margin: 0;
        }

        canvas { 
            background: #050505; border: 1px solid #444; 
            box-shadow: 0 0 50px #000; margin-bottom: 10px; 
            cursor: crosshair;
        }

        /* DASHBOARD */
        .dashboard {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            width: 700px; max-width: 95%;
            background: #151515; padding: 15px; border-radius: 8px; border: 1px solid #333;
            margin-bottom: 10px; font-family: 'Segoe UI', sans-serif;
        }

        .panel { padding: 10px; background: #222; border-radius: 5px; border: 1px solid #444; display: flex; flex-direction: column; justify-content: center; }
        
        .panel h3 { margin: 0 0 10px 0; font-size: 14px; color: #aaa; border-bottom: 1px solid #444; padding-bottom: 5px; font-weight: bold; text-align: center; }
        
        .formula { font-family: 'Times New Roman', serif; font-style: italic; font-size: 18px; text-align: center; margin-bottom: 10px; color: #fff; }
        
        .velocity-stack { display: flex; flex-direction: column; gap: 5px; font-family: monospace; font-size: 14px; }
        .velocity-row { display: flex; justify-content: space-between; align-items: center; padding: 2px 0; border-bottom: 1px dotted #333;}
        .velocity-row:last-child { border-bottom: none; }
        
        .dynamic-val { color: #4af; font-weight: bold; }
        .no-wrap { white-space: nowrap; }

        .controls { 
            width: 700px; max-width: 95%;
            background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #333; 
            display: flex; flex-direction: column; gap: 10px;
        }

        .control-row { display: flex; align-items: center; gap: 15px; }
        label { width: 140px; color: #bbb; font-size: 14px; text-align: right; }
        input[type=range] { flex-grow: 1; cursor: pointer; height: 5px; }
        
        .checkbox-group { display: flex; gap: 20px; align-items: center; justify-content: center; width: 100%; background: #222; padding: 8px; border-radius: 4px;}
        .checkbox-group label { width: auto; color: #fff; cursor: pointer; font-weight: bold; }
        input[type=checkbox] { transform: scale(1.3); margin-right: 8px; cursor: pointer; }

        .buttons-row { display: flex; gap: 10px; margin-bottom: 5px; justify-content: center; width: 100%; }
        button { padding: 8px 20px; background: #444; color: #fff; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; min-width: 100px; }
        button:hover { background: #555; }

        .legend { display: flex; gap: 20px; font-size: 12px; color: #aaa; margin-bottom: 5px; flex-wrap: wrap; justify-content: center;}
        .dot { width: 10px; height: 10px; display: inline-block; margin-right: 4px; border-radius: 50%; vertical-align: middle;}
        .bar { height: 4px; width: 25px; display: inline-block; margin-right: 4px; vertical-align: middle; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="panel">
            <h3>Vitesses (v = c/n)</h3>
            <div class="velocity-stack">
                <div class="velocity-row" style="color:#f88">
                    <span>Milieu 1 (n₁)</span>
                    <span class="no-wrap">v₁ = <span id="v1_val" class="dynamic-val">1.00</span>&nbsp;c</span>
                </div>
                <div class="velocity-row" style="color:#ff8">
                    <span>Milieu 2 (n₂)</span>
                    <span class="no-wrap">v₂ = <span id="v2_val" class="dynamic-val">0.67</span>&nbsp;c</span>
                </div>
            </div>
            <div style="font-size:11px; color:#666; text-align:center; margin-top:8px;">
                n augmente ➤ v diminue
            </div>
        </div>

        <div class="panel">
            <h3>Lois Optiques</h3>
            <div class="formula" style="font-size: 16px;">
                Réfraction: <span style="color:#f88">n₁</span>·sin(<span style="color:#f88">i₁</span>) = <span style="color:#ff8">n₂</span>·sin(<span style="color:#ff8">i₂</span>)<br>
                Réflexion: <span style="color:#f88">i₁</span> = <span style="color:#8f8">r</span>
            </div>
        </div>
    </div>

    <canvas id="simCanvas" width="700" height="450"></canvas>

    <div class="legend">
        <div><span class="bar" style="background:#f00;"></span>Rayon Incident</div>
        <div><span class="bar" style="background:#0f0;"></span>Rayon Réfléchi</div>
        <div><span class="bar" style="background:#ff0;"></span>Rayon Réfracté</div>
        <div><span class="dot" style="border:2px solid #48f;"></span>Huygens</div>
    </div>

    <div class="controls">
        <div class="buttons-row">
            <button onclick="resetSim()">↺ RESTART</button>
            <button onclick="togglePause()" id="pauseBtn">⏸ PAUSE</button>
        </div>

        <div class="checkbox-group">
            <span style="color:#aaa; font-size:14px;">ONDES :</span>
            <label style="color:#8f8"><input type="checkbox" id="checkReflect" onchange="drawOnly()"> Réflexion</label>
            <label style="color:#ff8"><input type="checkbox" id="checkRefract" checked onchange="drawOnly()"> Réfraction</label>
        </div>

        <div class="control-row">
            <label>Vitesse Simu</label>
            <input type="range" id="speedSlider" min="0.1" max="2.0" step="0.1" value="0.6">
        </div>

        <div class="control-row">
            <label style="color:#f55; font-weight:bold;">Angle Incident i₁</label>
            <input type="range" id="angleSlider" min="0" max="85" value="45">
        </div>
        
        <div class="control-row">
            <label>Indice n₁ (Haut)</label>
            <input type="range" id="n1Slider" min="1.0" max="2.5" step="0.1" value="1.0" oninput="resetSim()">
        </div>

        <div class="control-row">
            <label>Indice n₂ (Bas)</label>
            <input type="range" id="n2Slider" min="1.0" max="2.5" step="0.1" value="1.5" oninput="resetSim()">
        </div>

        <div class="control-row" style="border-top: 1px solid #333; padding-top: 10px;">
            <label>Densité Sources</label>
            <input type="range" id="densitySlider" min="5" max="80" step="1" value="30" oninput="initSources()">
        </div>
    </div>

<script>
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');

let paused = false;
function togglePause() {
    paused = !paused;
    document.getElementById('pauseBtn').innerText = paused ? "▶ LECTURE" : "⏸ PAUSE";
}

function drawOnly() {
    if(paused) requestAnimationFrame(update);
}

const W = 700; const H = 450;
const CX = W / 2;     
const SURFACE_Y = H / 2; 
const WAVELENGTH = 90; 

let time = -250; 
let sources = [];

class Source {
    constructor(x, y) {
        this.x = x; this.y = y;
        this.pulses = []; 
        this.lastWaveId = -1; 
        this.flash = 0;
    }

    checkImpact(distZero, px, py, lambda1) {
        let dx = this.x - CX;
        let dy = this.y - SURFACE_Y;
        let projDist = dx * px + dy * py;
        
        let delta = distZero - projDist;
        let waveId = Math.floor(delta / lambda1);
        
        // Anti-doublon strict
        if (waveId < 0) return;

        let phase = delta % lambda1;
        if (phase < 0) phase += lambda1;

        if (phase < 5 || phase > lambda1 - 5) {
             this.flash = 1.0;
             if (waveId > this.lastWaveId) {
                 this.pulses.push({ t0: time });
                 this.lastWaveId = waveId;
             }
        } else {
             this.flash *= 0.85;
        }
    }

    drawCircles(ctx, t, n, mode) {
        for(let i=this.pulses.length-1; i>=0; i--) {
            let p = this.pulses[i];
            let age = t - p.t0; 
            
            if(age < 0) continue; 

            let r = age / n; 
            
            if(r > 1200) { continue; }
            
            let alpha = Math.max(0, 0.7 - r/800);
            
            if(mode === 1) { 
                ctx.strokeStyle = `rgba(100, 255, 100, ${alpha})`;
            } else { 
                ctx.strokeStyle = `rgba(60, 160, 255, ${alpha})`;
            }
            
            ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(this.x, this.y, r, 0, Math.PI * 2); ctx.stroke();
        }
    }
    
    drawFlash(ctx) {
        if(this.flash > 0.05) {
            ctx.fillStyle = `rgba(255, 255, 100, ${this.flash})`; 
            ctx.beginPath(); ctx.arc(this.x, this.y, 6, 0, Math.PI*2); ctx.fill();
        }
    }
}

function initSources() {
    sources = [];
    let val = document.getElementById('densitySlider').value;
    let n = parseInt(val);
    if(n < 2) n = 2;
    for(let i=0; i<n; i++) {
        let sx = 50 + i * (600/(n-1));
        sources.push(new Source(sx, SURFACE_Y));
    }
}

function resetSim() { 
    time = -250; 
    initSources(); 
    if(paused) togglePause();
}

initSources();

function drawArc(ctx, x, y, r, start, end, color, label) {
    ctx.strokeStyle = color; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(x, y, r, start, end); ctx.stroke();
    let mid = (start + end)/2;
    let tx = x + (r + 25) * Math.cos(mid);
    let ty = y + (r + 25) * Math.sin(mid);
    ctx.fillStyle = color; ctx.font = "bold 14px sans-serif";
    ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText(label, tx, ty);
}

function drawLaserRay(ctx, x1, y1, x2, y2, color) {
    ctx.strokeStyle = color; 
    ctx.lineWidth = 4; 
    ctx.lineCap = "round";
    ctx.shadowBlur = 10;
    ctx.shadowColor = color;
    ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
    
    ctx.strokeStyle = "#fff";
    ctx.lineWidth = 1;
    ctx.shadowBlur = 0;
    ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
}

function update() {
    if(!paused) {
        let speed = parseFloat(document.getElementById('speedSlider').value);
        time += speed * 2;
    }

    let deg1 = parseFloat(document.getElementById('angleSlider').value);
    let n1 = parseFloat(document.getElementById('n1Slider').value);
    let n2 = parseFloat(document.getElementById('n2Slider').value);
    let i1 = deg1 * Math.PI / 180;
    
    let showReflect = document.getElementById('checkReflect').checked;
    let showRefract = document.getElementById('checkRefract').checked;

    let sin_i2 = (n1 * Math.sin(i1)) / n2;
    let isTIR = Math.abs(sin_i2) > 1.0;
    let i2 = isTIR ? Math.PI/2 : Math.asin(sin_i2);

    document.getElementById('v1_val').innerText = (1.0/n1).toFixed(2);
    document.getElementById('v2_val').innerText = (1.0/n2).toFixed(2);

    ctx.clearRect(0,0,W,H);

    ctx.font = "bold 20px monospace";
    ctx.fillStyle = "#888";
    ctx.textAlign = "left";
    ctx.textBaseline = "top";
    ctx.fillText("n₁=" + n1.toFixed(1), 20, 20);
    ctx.textBaseline = "bottom";
    ctx.fillText("n₂=" + n2.toFixed(1), 20, H - 20);

    let px1 = Math.sin(i1); let py1 = Math.cos(i1); 
    let fx1 = Math.cos(i1); let fy1 = -Math.sin(i1); 

    let px2 = Math.sin(i2); let py2 = Math.cos(i2);
    let fx2 = Math.cos(i2); let fy2 = -Math.sin(i2);

    let px_r = Math.sin(i1); let py_r = -Math.cos(i1);
    let fx_r = Math.cos(i1); let fy_r = Math.sin(i1); 

    let distZero = time / n1; 
    let lambda1 = WAVELENGTH / n1; 

    ctx.strokeStyle = "#555"; ctx.setLineDash([5,5]); ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(CX, 0); ctx.lineTo(CX, H); ctx.stroke();
    ctx.setLineDash([]);

    // === MILIEU 1 (HAUT) ===
    ctx.save();
    ctx.beginPath(); ctx.rect(0,0,W,SURFACE_Y); ctx.clip();
    
    // 1. Rayon Incident (ROUGE VISIBLE)
    drawLaserRay(ctx, CX - 600*px1, SURFACE_Y - 600*py1, CX, SURFACE_Y, "#f00");
    drawArc(ctx, CX, SURFACE_Y, 60, -Math.PI/2 - i1, -Math.PI/2, "#f88", "i₁");

    // 2. Fronts Incidents (Rouge)
    ctx.strokeStyle = "rgba(255, 60, 60, 0.8)"; ctx.lineWidth = 2;
    ctx.shadowBlur = 0;
    ctx.beginPath();
    let phase = distZero % lambda1;
    for(let k = -15; k < 30; k++) {
        let d = phase - k * lambda1;
        let cx = CX + d * px1; 
        let cy = SURFACE_Y + d * py1;
        ctx.moveTo(cx - 1000*fx1, cy - 1000*fy1);
        ctx.lineTo(cx + 1000*fx1, cy + 1000*fy1);
    }
    ctx.stroke();

    // 3. REFLEXION (Si coché)
    if(showReflect) {
        drawLaserRay(ctx, CX, SURFACE_Y, CX + 600*px_r, SURFACE_Y + 600*py_r, "#0f0");
        drawArc(ctx, CX, SURFACE_Y, 60, -Math.PI/2, -Math.PI/2 + i1, "#8f8", "r");
        
        for(let s of sources) s.drawCircles(ctx, time, n1, 1);
        
        ctx.strokeStyle = "rgba(100, 255, 100, 0.4)"; ctx.lineWidth = 2;
        ctx.beginPath();
        for(let k = -15; k < 30; k++) {
            let d1 = phase - k * lambda1;
            let cx = CX + d1 * px_r; 
            let cy = SURFACE_Y + d1 * py_r;
            ctx.moveTo(cx - 1000*fx_r, cy - 1000*fy_r);
            ctx.lineTo(cx + 1000*fx_r, cy + 1000*fy_r);
        }
        ctx.stroke();
    }
    ctx.restore();

    ctx.strokeStyle = "#aaa"; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(0, SURFACE_Y); ctx.lineTo(W, SURFACE_Y); ctx.stroke();

    // === MILIEU 2 (BAS) ===
    ctx.save();
    ctx.beginPath(); ctx.rect(0,SURFACE_Y,W,H-SURFACE_Y); ctx.clip();

    for(let s of sources) {
        if(!paused) s.checkImpact(distZero, px1, py1, lambda1);
        ctx.fillStyle = "#555"; ctx.beginPath(); ctx.arc(s.x, s.y, 3, 0, Math.PI*2); ctx.fill();
        s.drawFlash(ctx);
    }

    if(showRefract) {
        if(!isTIR) {
            drawLaserRay(ctx, CX, SURFACE_Y, CX + 600*px2, SURFACE_Y + 600*py2, "#ff0");
            let angleRay = Math.atan2(py2, px2); 
            drawArc(ctx, CX, SURFACE_Y, 60, angleRay, Math.PI/2, "#ff8", "i₂");
        }
        
        for(let s of sources) s.drawCircles(ctx, time, n2, 2);

        if(!isTIR) {
            ctx.strokeStyle = "rgba(255, 255, 0, 0.4)"; ctx.lineWidth = 2;
            ctx.shadowBlur = 0;
            ctx.beginPath();
            for(let k = -15; k < 30; k++) {
                let d1 = phase - k * lambda1;
                let d2 = d1 * (n1/n2);
                let cx = CX + d2 * px2;
                let cy = SURFACE_Y + d2 * py2;
                ctx.moveTo(cx - 1000*fx2, cy - 1000*fy2);
                ctx.lineTo(cx + 1000*fx2, cy + 1000*fy2);
            }
            ctx.stroke();
        }
    }
    ctx.restore();

    requestAnimationFrame(update);
}

update();
</script>
</body>
</html>
