<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Huygens : Param√®tres URL</title>
    <style>
        body { 
            background: #000; color: #eee; font-family: 'Segoe UI', sans-serif; 
            display: flex; flex-direction: column; align-items: center; 
            padding: 0; margin: 0; height: 100vh; overflow: hidden;
        }

        .container { display: flex; width: 100%; height: 100%; }

        /* SIDEBAR */
        .sidebar {
            width: 320px; background: #111; border-right: 1px solid #333;
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            overflow-y: auto; flex-shrink: 0; z-index: 10;
            box-shadow: 2px 0 15px rgba(0,0,0,0.5);
        }

        .main-view {
            flex-grow: 1; background: radial-gradient(circle at center, #151515 0%, #000 100%);
            display: flex; align-items: center; justify-content: center; position: relative;
        }

        canvas { background: #000; border: 1px solid #444; box-shadow: 0 0 80px #000; cursor: crosshair; }

        .panel { background: #1a1a1a; padding: 12px; border-radius: 6px; border: 1px solid #333; }
        .panel h3 { margin: 0 0 10px 0; font-size: 13px; color: #aaa; border-bottom: 1px solid #444; padding-bottom: 5px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;}

        .velocity-stack { display: flex; flex-direction: column; gap: 5px; font-family: monospace; font-size: 13px; }
        .velocity-row { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; border-bottom: 1px dotted #333;}
        .dynamic-val { color: #4af; font-weight: bold; }
        .no-wrap { white-space: nowrap; }

        .control-row { display: flex; align-items: center; justify-content: space-between; font-size: 13px; margin-bottom: 8px;}
        label { color: #ccc; }
        input[type=range] { width: 110px; cursor: pointer; height: 4px; accent-color: #4af; }
        
        .checkbox-group { display: flex; flex-direction: column; gap: 6px; }
        .checkbox-group label { color: #fff; cursor: pointer; font-size: 13px; display: flex; align-items: center; }
        input[type=checkbox] { transform: scale(1.2); margin-right: 8px; cursor: pointer; accent-color: #4af; }

        .buttons-row { display: flex; gap: 10px; margin-bottom: 5px; }
        button { flex: 1; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s;}
        button:hover { background: #555; border-color: #888; }
        
        /* Bouton Copier Sp√©cial */
        #shareBtn { background: #244; border-color: #488; }
        #shareBtn:hover { background: #355; }

        .legend { display: flex; flex-direction: column; gap: 6px; font-size: 12px; color: #aaa; }
        .legend-item { display: flex; align-items: center; }
        .dot { width: 10px; height: 10px; display: inline-block; margin-right: 8px; border-radius: 50%; }
        .bar { height: 3px; width: 20px; display: inline-block; margin-right: 8px; }

        /* Toast Notification */
        #toast {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 255, 100, 0.9); color: #000; padding: 10px 20px;
            border-radius: 20px; font-weight: bold; opacity: 0; pointer-events: none;
            transition: opacity 0.5s; z-index: 100;
        }

        .sidebar::-webkit-scrollbar { width: 6px; }
        .sidebar::-webkit-scrollbar-track { background: #111; }
        .sidebar::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>

<div id="toast">Lien copi√© dans le presse-papier !</div>

<div class="container">
    <div class="sidebar">
        <div style="text-align:center; font-weight:bold; color:#fff; font-size:18px; border-bottom:1px solid #333; padding-bottom:15px; margin-bottom:5px;">
            Optique Ondulatoire
        </div>

        <div class="buttons-row">
            <button onclick="resetSim()">‚Ü∫ RESET</button>
            <button onclick="togglePause()" id="pauseBtn">‚è∏ PAUSE</button>
        </div>
        
        <div class="buttons-row">
            <button id="shareBtn" onclick="copyLink()">üîó Copier le lien</button>
        </div>

        <div class="panel">
            <h3>Visualisation</h3>
            <div class="checkbox-group">
                <label style="color:#8f8"><input type="checkbox" id="checkReflect" onchange="handleParamChange(false)"> Onde R√©fl√©chie</label>
                <label style="color:#ff8"><input type="checkbox" id="checkRefract" checked onchange="handleParamChange(false)"> Onde R√©fract√©e</label>
            </div>
        </div>

        <div class="panel">
            <h3>Param√®tres</h3>
            <div class="control-row">
                <label style="color:#f55; font-weight:bold;">Angle i‚ÇÅ</label>
                <input type="range" id="angleSlider" min="0" max="85" value="45" oninput="handleParamChange(false)">
            </div>
            <div class="control-row">
                <label>Indice n‚ÇÅ (Haut)</label>
                <input type="range" id="n1Slider" min="1.0" max="2.5" step="0.1" value="1.0" oninput="handleParamChange(true)">
            </div>
            <div class="control-row">
                <label>Indice n‚ÇÇ (Bas)</label>
                <input type="range" id="n2Slider" min="1.0" max="2.5" step="0.1" value="1.5" oninput="handleParamChange(true)">
            </div>
        </div>

        <div class="panel">
            <h3>Vitesses (v = c/n)</h3>
            <div class="velocity-stack">
                <div class="velocity-row" style="color:#f88">
                    <span>Milieu 1 (n‚ÇÅ)</span>
                    <span class="no-wrap">v‚ÇÅ = <span id="v1_val" class="dynamic-val">1.00</span>&nbsp;c</span>
                </div>
                <div class="velocity-row" style="color:#ff8">
                    <span>Milieu 2 (n‚ÇÇ)</span>
                    <span class="no-wrap">v‚ÇÇ = <span id="v2_val" class="dynamic-val">0.67</span>&nbsp;c</span>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>Simulation</h3>
            <div class="control-row">
                <label>Vitesse Anim</label>
                <input type="range" id="speedSlider" min="0.1" max="2.0" step="0.1" value="0.6" oninput="handleParamChange(false)">
            </div>
            <div class="control-row">
                <label>Densit√© Sources</label>
                <input type="range" id="densitySlider" min="5" max="80" step="1" value="30" oninput="handleParamChange(true)">
            </div>
        </div>

        <div class="panel">
            <h3>L√©gende</h3>
            <div class="legend">
                <div class="legend-item"><span class="bar" style="background:#f00;"></span>Rayon Incident</div>
                <div class="legend-item"><span class="bar" style="background:#0f0;"></span>Rayon R√©fl√©chi</div>
                <div class="legend-item"><span class="bar" style="background:#ff0;"></span>Rayon R√©fract√©</div>
                <div class="legend-item"><span class="dot" style="border:2px solid #48f;"></span>Huygens (Onde)</div>
                <div class="legend-item"><span class="dot" style="background:#fff;"></span>Source</div>
            </div>
        </div>
    </div>

    <div class="main-view">
        <canvas id="simCanvas" width="800" height="600"></canvas>
    </div>
</div>

<script>
const canvas = document.getElementById('simCanvas');
const ctx = canvas.getContext('2d');

const W = 800; const H = 600;
const CX = W / 2;     
const SURFACE_Y = H / 2; 
const WAVELENGTH = 90; 

let time = -250; 
let sources = [];
let paused = false;

// --- GESTION URL & PARAMETRES ---

function getURLParams() {
    const params = new URLSearchParams(window.location.search);
    // On met √† jour les inputs s'ils existent dans l'URL
    if(params.has('i1')) document.getElementById('angleSlider').value = params.get('i1');
    if(params.has('n1')) document.getElementById('n1Slider').value = params.get('n1');
    if(params.has('n2')) document.getElementById('n2Slider').value = params.get('n2');
    if(params.has('s')) document.getElementById('speedSlider').value = params.get('s');
    if(params.has('d')) document.getElementById('densitySlider').value = params.get('d');
    
    if(params.has('refl')) document.getElementById('checkReflect').checked = (params.get('refl') === '1');
    if(params.has('refr')) document.getElementById('checkRefract').checked = (params.get('refr') === '1');
}

function updateURL() {
    const params = new URLSearchParams();
    params.set('i1', document.getElementById('angleSlider').value);
    params.set('n1', document.getElementById('n1Slider').value);
    params.set('n2', document.getElementById('n2Slider').value);
    params.set('s', document.getElementById('speedSlider').value);
    params.set('d', document.getElementById('densitySlider').value);
    
    params.set('refl', document.getElementById('checkReflect').checked ? '1' : '0');
    params.set('refr', document.getElementById('checkRefract').checked ? '1' : '0');

    // Mise √† jour de l'URL sans recharger la page
    window.history.replaceState({}, '', `${window.location.pathname}?${params}`);
}

function copyLink() {
    updateURL(); // Assure que l'URL est √† jour
    navigator.clipboard.writeText(window.location.href).then(() => {
        const toast = document.getElementById('toast');
        toast.style.opacity = '1';
        setTimeout(() => toast.style.opacity = '0', 2000);
    });
}

// Fonction centrale appel√©e par les inputs
// needsReset : true si le changement demande de recharger les sources ou le temps
function handleParamChange(needsReset) {
    updateURL();
    if(needsReset) {
        // Pour la densit√© ou les indices, on reset souvent pour √©viter les sauts
        // Mais pour n1/n2 on peut juste laisser resetSim g√©rer
        // Si c'est juste la densit√© :
        initSources();
    }
}

// --- MOTEUR PHYSIQUE ---

function togglePause() {
    paused = !paused;
    document.getElementById('pauseBtn').innerText = paused ? "‚ñ∂ LECTURE" : "‚è∏ PAUSE";
}

function drawOnly() {
    updateURL(); // Checkbox change
    if(paused) requestAnimationFrame(update);
}

class Source {
    constructor(x, y) {
        this.x = x; this.y = y;
        this.pulses = []; 
        this.lastWaveId = -1; 
        this.flash = 0;
    }

    checkImpact(distZero, px, py, lambda1) {
        let dx = this.x - CX;
        let dy = this.y - SURFACE_Y;
        let projDist = dx * px + dy * py;
        let delta = distZero - projDist;
        let waveId = Math.floor(delta / lambda1);
        
        if (waveId < 0) return;

        let phase = delta % lambda1;
        if (phase < 0) phase += lambda1;

        if (phase < 5 || phase > lambda1 - 5) {
             this.flash = 1.0;
             if (waveId > this.lastWaveId) {
                 this.pulses.push({ t0: time });
                 this.lastWaveId = waveId;
             }
        } else {
             this.flash *= 0.85;
        }
    }

    drawCircles(ctx, t, n, mode) {
        for(let i=this.pulses.length-1; i>=0; i--) {
            let p = this.pulses[i];
            let age = t - p.t0; 
            if(age < 0) continue; 
            let r = age / n; 
            if(r > 1200) continue; 
            let alpha = Math.max(0, 0.7 - r/800);
            
            if(mode === 1) ctx.strokeStyle = `rgba(100, 255, 100, ${alpha})`;
            else ctx.strokeStyle = `rgba(60, 160, 255, ${alpha})`;
            
            ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(this.x, this.y, r, 0, Math.PI * 2); ctx.stroke();
        }
    }
    
    drawFlash(ctx) {
        if(this.flash > 0.05) {
            ctx.fillStyle = `rgba(255, 255, 100, ${this.flash})`; 
            ctx.beginPath(); ctx.arc(this.x, this.y, 6, 0, Math.PI*2); ctx.fill();
        }
    }
}

function initSources() {
    sources = [];
    let val = document.getElementById('densitySlider').value;
    let n = parseInt(val);
    if(n < 2) n = 2;
    for(let i=0; i<n; i++) {
        let sx = 50 + i * (700/(n-1));
        sources.push(new Source(sx, SURFACE_Y));
    }
}

function resetSim() { 
    time = -250; 
    initSources(); 
    updateURL(); // Sync au reset
    if(paused) togglePause();
}

// INITIALISATION
// 1. Lire l'URL
getURLParams();
// 2. Initier
initSources();

function drawArc(ctx, x, y, r, start, end, color, label) {
    ctx.strokeStyle = color; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(x, y, r, start, end); ctx.stroke();
    let mid = (start + end)/2;
    let tx = x + (r + 25) * Math.cos(mid);
    let ty = y + (r + 25) * Math.sin(mid);
    ctx.fillStyle = color; ctx.font = "bold 14px sans-serif";
    ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText(label, tx, ty);
}

function drawLaserRay(ctx, x1, y1, x2, y2, color) {
    ctx.strokeStyle = color; ctx.lineWidth = 4; ctx.lineCap = "round";
    ctx.shadowBlur = 10; ctx.shadowColor = color;
    ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
    ctx.strokeStyle = "#fff"; ctx.lineWidth = 1; ctx.shadowBlur = 0;
    ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
}

function update() {
    if(!paused) {
        let speed = parseFloat(document.getElementById('speedSlider').value);
        time += speed * 2;
    }

    let deg1 = parseFloat(document.getElementById('angleSlider').value);
    let n1 = parseFloat(document.getElementById('n1Slider').value);
    let n2 = parseFloat(document.getElementById('n2Slider').value);
    let i1 = deg1 * Math.PI / 180;
    
    let showReflect = document.getElementById('checkReflect').checked;
    let showRefract = document.getElementById('checkRefract').checked;

    let sin_i2 = (n1 * Math.sin(i1)) / n2;
    let isTIR = Math.abs(sin_i2) > 1.0;
    let i2 = isTIR ? Math.PI/2 : Math.asin(sin_i2);

    document.getElementById('v1_val').innerText = (1.0/n1).toFixed(2);
    document.getElementById('v2_val').innerText = (1.0/n2).toFixed(2);

    ctx.clearRect(0,0,W,H);

    ctx.font = "bold 20px monospace";
    ctx.fillStyle = "#222";
    ctx.textAlign = "left";
    ctx.textBaseline = "top"; ctx.fillText("n‚ÇÅ=" + n1.toFixed(1), 20, 20);
    ctx.textBaseline = "bottom"; ctx.fillText("n‚ÇÇ=" + n2.toFixed(1), 20, H - 20);

    let px1 = Math.sin(i1); let py1 = Math.cos(i1); 
    let fx1 = Math.cos(i1); let fy1 = -Math.sin(i1); 

    let px2 = Math.sin(i2); let py2 = Math.cos(i2);
    let fx2 = Math.cos(i2); let fy2 = -Math.sin(i2);

    let px_r = Math.sin(i1); let py_r = -Math.cos(i1);
    let fx_r = Math.cos(i1); let fy_r = Math.sin(i1); 

    let distZero = time / n1; 
    let lambda1 = WAVELENGTH / n1; 

    ctx.strokeStyle = "#444"; ctx.setLineDash([5,5]); ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(CX, 0); ctx.lineTo(CX, H); ctx.stroke();
    ctx.setLineDash([]);

    // === HAUT ===
    ctx.save();
    ctx.beginPath(); ctx.rect(0,0,W,SURFACE_Y); ctx.clip();
    
    drawLaserRay(ctx, CX - 700*px1, SURFACE_Y - 700*py1, CX, SURFACE_Y, "#f00");
    drawArc(ctx, CX, SURFACE_Y, 60, -Math.PI/2 - i1, -Math.PI/2, "#f88", "i‚ÇÅ");

    ctx.strokeStyle = "rgba(255, 60, 60, 0.8)"; ctx.lineWidth = 2; ctx.shadowBlur = 0;
    ctx.beginPath();
    let phase = distZero % lambda1;
    for(let k = -15; k < 35; k++) {
        let d = phase - k * lambda1;
        let cx = CX + d * px1; let cy = SURFACE_Y + d * py1;
        ctx.moveTo(cx - 1000*fx1, cy - 1000*fy1);
        ctx.lineTo(cx + 1000*fx1, cy + 1000*fy1);
    }
    ctx.stroke();

    if(showReflect) {
        drawLaserRay(ctx, CX, SURFACE_Y, CX + 700*px_r, SURFACE_Y + 700*py_r, "#0f0");
        drawArc(ctx, CX, SURFACE_Y, 60, -Math.PI/2, -Math.PI/2 + i1, "#8f8", "r");
        for(let s of sources) s.drawCircles(ctx, time, n1, 1);
        
        ctx.strokeStyle = "rgba(100, 255, 100, 0.4)"; ctx.lineWidth = 2;
        ctx.beginPath();
        for(let k = -15; k < 35; k++) {
            let d1 = phase - k * lambda1;
            let cx = CX + d1 * px_r; let cy = SURFACE_Y + d1 * py_r;
            ctx.moveTo(cx - 1000*fx_r, cy - 1000*fy_r);
            ctx.lineTo(cx + 1000*fx_r, cy + 1000*fy_r);
        }
        ctx.stroke();
    }
    ctx.restore();

    ctx.strokeStyle = "#888"; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.moveTo(0, SURFACE_Y); ctx.lineTo(W, SURFACE_Y); ctx.stroke();

    // === BAS ===
    ctx.save();
    ctx.beginPath(); ctx.rect(0,SURFACE_Y,W,H-SURFACE_Y); ctx.clip();

    if(showRefract) {
        if(!isTIR) {
            drawLaserRay(ctx, CX, SURFACE_Y, CX + 700*px2, SURFACE_Y + 700*py2, "#ff0");
            let angleRay = Math.atan2(py2, px2); 
            drawArc(ctx, CX, SURFACE_Y, 60, angleRay, Math.PI/2, "#ff8", "i‚ÇÇ");
        }
        for(let s of sources) s.drawCircles(ctx, time, n2, 2);

        if(!isTIR) {
            ctx.strokeStyle = "rgba(255, 255, 0, 0.4)"; ctx.lineWidth = 2; ctx.shadowBlur = 0;
            ctx.beginPath();
            for(let k = -15; k < 35; k++) {
                let d1 = phase - k * lambda1;
                let d2 = d1 * (n1/n2);
                let cx = CX + d2 * px2; let cy = SURFACE_Y + d2 * py2;
                ctx.moveTo(cx - 1000*fx2, cy - 1000*fy2);
                ctx.lineTo(cx + 1000*fx2, cy + 1000*fy2);
            }
            ctx.stroke();
        }
    }
    ctx.restore();

    // === SOURCES & FLASH (Top Layer) ===
    for(let s of sources) {
        if(!paused) s.checkImpact(distZero, px1, py1, lambda1);
        ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(s.x, s.y, 3, 0, Math.PI*2); ctx.fill();
        s.drawFlash(ctx);
    }

    requestAnimationFrame(update);
}

update();
</script>
</body>
</html>
